// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  USER
  ADMIN
}

enum AdCondition {
  NEW
  USED
}

enum AdStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FeatureRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReportReason {
  SPAM
  FRAUD
  INAPPROPRIATE
  DUPLICATE
  OTHER
}

// ==================== MODELS ====================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String // Hashed with bcrypt
  phone         String?
  profileImage  String?
  role          UserRole  @default(USER)
  isBanned      Boolean   @default(false)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  ads             Ad[]
  conversations   Conversation[]   @relation("UserConversations")
  messages        Message[]
  favorites       Favorite[]
  reports         Report[]
  featureRequests FeatureRequest[]
  sentMessages    Message[]        @relation("SentMessages")
  store           Store?
  adViews         AdView[]
  recentlyViewed  RecentlyViewed[]
  phoneViews      PhoneView[]
  interests       UserInterest[]
  followedStores  StoreFollower[]

  @@index([email])
  @@index([role])
  @@index([isBanned])
  @@map("users")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String? // Lucide icon name or URL
  image       String? // Category image URL
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  ads           Ad[]
  subCategories SubCategory[]
  userInterests UserInterest[]

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model SubCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  categoryId String

  // Relations
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  ads      Ad[]

  @@unique([slug, categoryId])
  @@index([categoryId])
  @@index([isActive])
  @@map("sub_categories")
}

model Ad {
  id            String      @id @default(cuid())
  title         String
  description   String      @db.Text
  price         Decimal     @db.Decimal(12, 2)
  condition     AdCondition
  images        String[] // Array of Cloudinary image URLs
  city          String
  area          String?
  phone         String? // Contact phone (optional, can use user's phone)
  isApproved    Boolean     @default(false)
  isFeatured    Boolean     @default(false)
  featuredUntil DateTime?
  status        AdStatus    @default(PENDING)
  views         Int         @default(0)
  leads         Int         @default(0) // Track leads (inquiries, phone views, etc.)

  // Commission feature fields
  isSold           Boolean   @default(false)
  soldAt           DateTime?
  commissionPaid   Boolean   @default(false)
  commissionAmount Decimal?  @db.Decimal(12, 2)
  commissionPaidAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign Keys
  userId        String
  categoryId    String
  subCategoryId String?
  storeId       String?

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  category        Category         @relation(fields: [categoryId], references: [id])
  subCategory     SubCategory?     @relation(fields: [subCategoryId], references: [id])
  store           Store?           @relation("StoreAds", fields: [storeId], references: [id])
  conversations   Conversation[]
  favorites       Favorite[]
  reports         Report[]
  featureRequests FeatureRequest[]
  adViews         AdView[]
  recentlyViewed  RecentlyViewed[]
  phoneViews      PhoneView[]

  @@index([title])
  @@index([city])
  @@index([categoryId])
  @@index([subCategoryId])
  @@index([storeId])
  @@index([createdAt])
  @@index([isFeatured])
  @@index([isApproved])
  @@index([status])
  @@index([price])
  @@index([userId])
  @@index([isFeatured, featuredUntil])
  @@index([isSold])
  @@map("ads")
}

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Foreign Keys
  adId   String
  userId String // The user who initiated the conversation

  // Relations
  ad       Ad        @relation(fields: [adId], references: [id], onDelete: Cascade)
  user     User      @relation("UserConversations", fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([adId, userId])
  @@index([adId])
  @@index([userId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id        String    @id @default(cuid())
  content   String    @db.Text
  isSeen    Boolean   @default(false)
  seenAt    DateTime?
  createdAt DateTime  @default(now())

  // Foreign Keys
  conversationId String
  senderId       String
  receiverId     String

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver     User         @relation(fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
  @@index([isSeen])
  @@index([createdAt])
  @@map("messages")
}

model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign Keys
  userId String
  adId   String

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  ad   Ad   @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@unique([userId, adId])
  @@index([userId])
  @@index([adId])
  @@map("favorites")
}

model Report {
  id          String       @id @default(cuid())
  reason      ReportReason
  description String?      @db.Text
  status      String       @default("PENDING") // PENDING, RESOLVED, DISMISSED
  createdAt   DateTime     @default(now())
  resolvedAt  DateTime?

  // Foreign Keys
  adId       String
  reporterId String
  resolvedBy String?

  // Relations
  ad       Ad   @relation(fields: [adId], references: [id], onDelete: Cascade)
  reporter User @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([adId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
  @@map("reports")
}

model FeatureRequest {
  id              String               @id @default(cuid())
  screenshotImage String // Cloudinary URL of payment proof
  status          FeatureRequestStatus @default(PENDING)
  amount          Decimal              @default(2000.00) @db.Decimal(10, 2)
  durationDays    Int                  @default(7)
  notes           String?              @db.Text
  createdAt       DateTime             @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?

  // Foreign Keys
  adId   String
  userId String

  // Relations
  ad   Ad   @relation(fields: [adId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([adId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("feature_requests")
}

model BankDetails {
  id            String   @id @default(cuid())
  bankName      String
  accountTitle  String
  accountNumber String
  iban          String
  branchCode    String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("bank_details")
}

model SiteConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("site_config")
}

model Store {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  logo        String? // Cloudinary URL
  coverImage  String? // Cloudinary URL
  phone       String
  email       String
  website     String?
  address     String?
  city        String
  area        String?
  isVerified  Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  ownerId String @unique

  // Relations
  owner          User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ads            Ad[]             @relation("StoreAds")
  storeFollowers StoreFollower[]

  @@index([slug])
  @@index([city])
  @@index([isVerified])
  @@index([isActive])
  @@map("stores")
}

// Track individual ad views
model AdView {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign Keys
  adId   String
  userId String? // Nullable for anonymous users

  // Relations
  ad   Ad      @relation(fields: [adId], references: [id], onDelete: Cascade)
  user User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([adId])
  @@index([userId])
  @@index([createdAt])
  @@map("ad_views")
}

// Track recently viewed ads per user
model RecentlyViewed {
  id        String   @id @default(cuid())
  viewedAt  DateTime @default(now())

  // Foreign Keys
  adId   String
  userId String

  // Relations
  ad   Ad   @relation(fields: [adId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([adId, userId])
  @@index([userId])
  @@index([viewedAt])
  @@map("recently_viewed")
}

// Track phone number views in chat
model PhoneView {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign Keys
  adId   String
  userId String // Who viewed the phone
  conversationId String?

  // Relations
  ad   Ad   @relation(fields: [adId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([adId])
  @@index([userId])
  @@index([createdAt])
  @@map("phone_views")
}

// User interests for personalized feed
model UserInterest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign Keys
  userId     String
  categoryId String

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@index([categoryId])
  @@map("user_interests")
}

// Store followers - users interested in stores
model StoreFollower {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Foreign Keys
  storeId String
  userId  String

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storeId, userId])
  @@index([storeId])
  @@index([userId])
  @@map("store_followers")
}
